<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enjoyTrip.OdysseyFrontiers.plan.model.mapper.PlanMapper">

    <resultMap id="planResultMap" type="com.enjoyTrip.OdysseyFrontiers.plan.model.dto.PlanDto">
        <id property="planId" column="plan_id"/>
        <result property="memberId" column="member_id"/>
        <result property="name" column="name"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="season" column="season"/>
        <result property="accessType" column="access_type"/>
        <result property="startTime" column="start_time"/>
        <result property="recentUpdateTime" column="recent_update_time"/>
        <collection property="planDetails" ofType="com.enjoyTrip.OdysseyFrontiers.plan.model.dto.PlanDetailDto">
            <id property="planDetailId" column="plan_detail_id"/>
            <result property="planId" column="plan_id"/>
            <result property="day" column="day"/>
            <result property="contentId" column="content_id"/>
            <result property="description" column="description"/>
            <result property="planTime" column="plan_time"/>
        </collection>
    </resultMap>

    <sql id="search">
        <trim prefix="WHERE" prefixOverrides="AND">
            <if test="sidoCode != null and sidoCode != 0">
                AND info.sido_code = #{sidoCode}
            </if>
            <if test="gugunCode != null and gugunCode != 0">
                AND info.gugun_code = #{gugunCode}
            </if>
            <if test="contentTypeId != null and contentTypeId != 0">
                AND info.content_type_id = #{contentTypeId}
            </if>
            <if test="keyword != null and keyword != 'no' and keyword != ''">
                AND (info.title LIKE CONCAT('%', #{keyword}, '%') OR info.description LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </trim>
    </sql>

    <select id="searchPlans" parameterType="map" resultMap="planResultMap">
        SELECT p.*, pd.*
        FROM plan p
        JOIN plan_detail pd ON p.plan_id = pd.plan_id
        JOIN attraction_info info ON pd.content_id = info.content_id
        <include refid="search"/>
        GROUP BY
        p.plan_id,
        p.member_id,
        p.name,
        p.title,
        p.description,
        p.season,
        p.access_type,
        p.start_time,
        p.recent_update_time,
        pd.plan_detail_id,
        pd.plan_id,
        pd.day,
        pd.content_id,
        pd.description,
        pd.plan_time
        ORDER BY p.recent_update_time DESC
        LIMIT 5;
    </select>

    <select id="getPlan" parameterType="long" resultMap="planResultMap">
        SELECT p.*, pd.*
        FROM plan p
                 JOIN plan_detail pd ON p.plan_id = pd.plan_id
        WHERE p.plan_id = #{planId}
    </select>

    <insert id="insertPlan" useGeneratedKeys="true" keyProperty="planId">
        INSERT INTO plan (member_id, title, description, season, start_time, access_type, recent_update_time)
        VALUES (#{memberId}, #{title}, #{description}, #{season}, #{startTime}, #{accessType}, #{recentUpdateTime})
    </insert>

    <insert id="insertPlanDetail">
        INSERT INTO plan_detail (plan_id, day, content_id, description, plan_time)
        VALUES (#{planId}, #{day}, #{contentId}, #{description}, #{planTime})
    </insert>

    <update id="updatePlan">
        UPDATE plan
        SET member_id = #{memberId},
            title = #{title},
            description = #{description},
            season = #{season},
            start_time = #{startTime},
            access_type = #{accessType},
            recent_update_time = #{recentUpdateTime}
        WHERE plan_id = #{planId}
    </update>

    <delete id="deletePlan">
        DELETE FROM plan
        WHERE plan_id = #{planId}
    </delete>

    <delete id="deletePlanDetails">
        DELETE FROM plan_detail
        WHERE plan_id = #{planId}
    </delete>
</mapper>
